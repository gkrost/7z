name: Build 7z Linux x64

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-linux-x64:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential g++ make
        
    - name: Install ASM assembler for optimizations
      run: |
        set -e
        echo "Installing ASMC assembler for ASM optimizations..."
        git clone --depth 1 https://github.com/nidud/asmc.git /tmp/asmc
        sudo cp /tmp/asmc/bin/asmc /usr/local/bin/
        sudo chmod +x /usr/local/bin/asmc
        echo "ASMC version:"
        asmc -h 2>&1 | head -3 || echo "ASMC help output not available"
        
    - name: Build 7z with ASM optimizations enabled
      run: |
        set -e
        cd CPP/7zip/Bundles/Alone
        echo "Building with cmpl_gcc_x64.mak which enables USE_ASM=1..."
        echo "This will attempt to compile ASM-optimized implementations for:"
        echo "  - CRC calculations (7zCrcOpt)"
        echo "  - AES encryption (AesOpt)"
        echo "  - SHA1/SHA256 hashing (Sha1Opt, Sha256Opt)"
        echo "  - LZMA encoding (LzFindOpt)"
        echo "  - Sorting (Sort)"
        echo "  - XZ CRC64 (XzCrc64Opt)"
        make -j$(nproc) -f ../../cmpl_gcc_x64.mak || {
          echo "ASM build failed. This is expected if ASMC has compatibility issues."
          echo "Falling back to regular GCC build without ASM optimizations..."
          make clean -f ../../cmpl_gcc.mak
          make -j$(nproc) -f ../../cmpl_gcc.mak
        }
        
    - name: Verify build
      run: |
        cd CPP/7zip/Bundles/Alone
        # Check both possible build outputs (x64 for ASM, g for non-ASM)
        if [ -f b/g_x64/7za ]; then
          echo "Found ASM-optimized build:"
          ls -lh b/g_x64/7za
          file b/g_x64/7za
          ./b/g_x64/7za --help
        elif [ -f b/g/7za ]; then
          echo "Found standard build (ASM build failed):"
          ls -lh b/g/7za
          file b/g/7za
          ./b/g/7za --help
        else
          echo "Error: No build output found!"
          exit 1
        fi
        
    - name: Run benchmark test
      run: |
        cd CPP/7zip/Bundles/Alone
        if [ -f b/g_x64/7za ]; then
          ./b/g_x64/7za b
        else
          ./b/g/7za b
        fi
        
    - name: Verify ASM optimizations
      run: |
        cd CPP/7zip/Bundles/Alone
        echo "Checking for ASM-optimized object files..."
        if [ -d b/g_x64 ]; then
          echo "ASM build directory exists. Checking for ASM object files:"
          ls -lh b/g_x64/*.o 2>/dev/null | grep -E "(7zCrcOpt|AesOpt|Sha1Opt|Sha256Opt|LzFindOpt|XzCrc64Opt|Sort)" && echo "✓ ASM optimizations enabled!" || echo "⚠ No ASM object files found (C fallback used)"
        else
          echo "⚠ ASM build directory not found - using standard C implementations"
        fi
        
    - name: Upload 7za binary
      uses: actions/upload-artifact@v4
      with:
        name: 7za-linux-x64
        path: |
          CPP/7zip/Bundles/Alone/b/g_x64/7za
          CPP/7zip/Bundles/Alone/b/g/7za
        retention-days: 30
        if-no-files-found: warn
