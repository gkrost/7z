name: Build 7z Linux x64

# This workflow requires GCC 13.3.0 to meet the minimum compiler version
# requirements for building 7z with all optimizations enabled.
# Using apt cache action to speed up repeated GCC installations.

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-linux-x64:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Cache apt packages
      uses: actions/cache@v4
      with:
        path: /var/cache/apt/archives
        key: ${{ runner.os }}-apt-gcc13-${{ hashFiles('.github/workflows/build-linux-x64.yml') }}
        restore-keys: |
          ${{ runner.os }}-apt-gcc13-
      
    - name: Install GCC 13 and build dependencies
      run: |
        # Add PPA for GCC 13.x (provides GCC 13.3.0 on Ubuntu 24.04)
        sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y
        sudo apt-get update
        # Install GCC 13 (version 13.3.0 on Ubuntu 24.04)
        sudo apt-get install -y gcc-13 g++-13
        # Set GCC 13 as the default compiler
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 130 --slave /usr/bin/g++ g++ /usr/bin/g++-13
        sudo update-alternatives --set gcc /usr/bin/gcc-13
        # Install other build dependencies
        sudo apt-get install -y build-essential make
        # Verify GCC version
        gcc --version
        g++ --version
        
    - name: Install ASM assembler for optimizations
      run: |
        set -e
        echo "Installing ASMC assembler for ASM optimizations..."
        git clone --depth 1 https://github.com/nidud/asmc.git /tmp/asmc
        # Ensure ASMC binary exists; if not, attempt to build from source
        if [ ! -f /tmp/asmc/bin/asmc ]; then
          echo "ASMC binary not found at /tmp/asmc/bin/asmc. Attempting to build from source..."
          cd /tmp/asmc
          make -j"$(nproc)"
          cd -
        fi

        if [ ! -f /tmp/asmc/bin/asmc ]; then
          echo "ERROR: ASMC binary still not found at /tmp/asmc/bin/asmc after build attempt."
          exit 1
        fi
        sudo cp /tmp/asmc/bin/asmc /usr/local/bin/
        sudo chmod +x /usr/local/bin/asmc
        echo "ASMC installed successfully"
        asmc -h 2>&1 | head -5 || true
        
    - name: Build 7z with ASM optimizations enabled
      run: |
        cd CPP/7zip/Bundles/Alone
        echo "Building with cmpl_gcc_x64.mak which enables USE_ASM=1..."
        echo "This will attempt to compile ASM-optimized implementations for:"
        echo "  - CRC calculations (7zCrcOpt)"
        echo "  - AES encryption (AesOpt)"
        echo "  - SHA1/SHA256 hashing (Sha1Opt, Sha256Opt)"
        echo "  - LZMA encoding (LzFindOpt)"
        echo "  - Sorting (Sort)"
        echo "  - XZ CRC64 (XzCrc64Opt)"
        make -j$(nproc) -f ../../cmpl_gcc_x64.mak || {
          echo "ASM build failed. This is expected if ASMC has compatibility issues."
          echo "Falling back to regular GCC build without ASM optimizations..."
          make clean -f ../../cmpl_gcc_x64.mak
          make -j$(nproc) -f ../../cmpl_gcc.mak
        }
        
    - name: Verify build
      run: |
        cd CPP/7zip/Bundles/Alone
        # Check both possible build outputs (x64 for ASM, g for non-ASM)
        if [ -f b/g_x64/7za ]; then
          echo "Found ASM-optimized build:"
          ls -lh b/g_x64/7za
          file b/g_x64/7za
          ./b/g_x64/7za --help
        elif [ -f b/g/7za ]; then
          echo "Found standard build (ASM build failed):"
          ls -lh b/g/7za
          file b/g/7za
          ./b/g/7za --help
        else
          echo "Error: No build output found!"
          exit 1
        fi
        
    - name: Run benchmark test
      run: |
        cd CPP/7zip/Bundles/Alone
        if [ -f b/g_x64/7za ]; then
          ./b/g_x64/7za b
        else
          ./b/g/7za b
        fi
        
    - name: Verify ASM optimizations
      run: |
        cd CPP/7zip/Bundles/Alone
        echo "Checking for ASM-optimized object files..."
        if [ -d b/g_x64 ]; then
          echo "ASM build directory exists. Checking for ASM object files:"
          if compgen -G "b/g_x64/*.o" > /dev/null; then
            if printf '%s\n' b/g_x64/*.o | grep -qE "(7zCrcOpt|AesOpt|Sha1Opt|Sha256Opt|LzFindOpt|XzCrc64Opt|Sort)"; then
              echo "✓ ASM optimizations enabled!"
              printf '%s\n' b/g_x64/*.o | grep -E "(7zCrcOpt|AesOpt|Sha1Opt|Sha256Opt|LzFindOpt|XzCrc64Opt|Sort)"
            else
              echo "⚠ No ASM object files found (C fallback used)"
              echo ""
              echo "Diagnostic information:"
              echo "Directory listing of b/:"
              ls -lah b/ || echo "Failed to list b/"
              echo ""
              echo "Directory listing of b/g_x64/:"
              ls -lah b/g_x64/ || echo "Failed to list b/g_x64/"
              echo ""
              echo "Object files in b/g_x64/:"
              printf '%s\n' b/g_x64/*.o 2>/dev/null || echo "No .o files found"
            fi
          else
            echo "⚠ No object files produced in ASM build directory"
            echo ""
            echo "Diagnostic information:"
            echo "Directory listing of b/:"
            ls -lah b/ || echo "Failed to list b/"
            echo ""
            echo "Directory listing of b/g_x64/:"
            ls -lah b/g_x64/ || echo "Failed to list b/g_x64/"
          fi
        else
          echo "⚠ ASM build directory not found - using standard C implementations"
          echo ""
          echo "Diagnostic information:"
          echo "Directory listing of b/:"
          ls -lah b/ || echo "b/ directory does not exist"
        fi
        
    - name: Upload 7za binary
      uses: actions/upload-artifact@v4
      with:
        name: 7za-linux-x64
        path: |
          CPP/7zip/Bundles/Alone/b/g_x64/7za
          CPP/7zip/Bundles/Alone/b/g/7za
        retention-days: 30
        if-no-files-found: warn
